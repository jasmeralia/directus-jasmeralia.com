---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { directusFetchItems, fileUrl } from '../../lib/directus';

const games = await directusFetchItems('games', {
  fields: [
    'id',
    'title',
    'slug',
    'release_year',
    'game_status',
    'player_status',
    'cover_image.id',
    'cover_image.filename_disk',
    'genres.id',
    'genres.genres_id.id',
    'genres.genres_id.name',
    'engines.id',
    'engines.engines_id.id',
    'engines.engines_id.title',
  ],
  sort: ['sort', 'title'],
  limit: 500,
});

const gameIds = games.map((game) => game.id).filter((id) => typeof id === "number");
const reviewedGameIds = new Set();
if (gameIds.length) {
  const reviews = await directusFetchItems("reviews", {
    fields: ["game.id"],
    filter: { status: { _eq: "published" }, game: { _in: gameIds } },
    limit: 500,
  });
  for (const review of reviews ?? []) {
    const id = review?.game?.id;
    if (typeof id === "number") reviewedGameIds.add(id);
  }
}

const labelize = (value) => value ? value.replace(/_/g, " ").replace(/\b\w/g, (c) => c.toUpperCase()) : "";
---

<BaseLayout title="Games">
  <div slot="head">
    <style>
      main{padding:2rem;}
      .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;}
      .card{border:1px solid #2b2b2b;border-radius:12px;overflow:hidden;background:#111;}
      .card.reviewed{border-color:#d3a43b;box-shadow:0 0 0 1px rgba(211,164,59,.25);}
      .card a{color:inherit;text-decoration:none;display:block;}
      .thumb{aspect-ratio:2/3;background:#000;display:flex;align-items:center;justify-content:center;}
      .thumb img{width:100%;height:100%;object-fit:contain;display:block;}
      .meta{padding:.75rem 1rem;}
      .title{font-weight:700;}
      .year{opacity:.75;font-size:.9rem;}
      .tags{display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.5rem;}
      .tag{font-size:.75rem;padding:.2rem .5rem;border-radius:999px;background:#1a1a1a;border:1px solid #2b2b2b;opacity:.9;}
    </style>
  </div>
  <main>
      <h1>Games</h1>
      <div class="grid">
        {games.map((g) => {
          const img = g.cover_image ? fileUrl(g.cover_image as any) : null;
          const genres = (g.genres ?? []).map((genre) => genre?.genres_id?.name).filter(Boolean);
          const engines = (g.engines ?? []).map((engine) => engine?.engines_id?.title).filter(Boolean);
          const reviewed = reviewedGameIds.has(g.id);
          return (
            <div class={`card${reviewed ? " reviewed" : ""}`}>
              <a href={`/games/${g.slug}/index.html`}>
                <div class="thumb">
                  {img ? <img src={img} alt={g.title} loading="lazy" /> : <span>No cover</span>}
                </div>
                <div class="meta">
                  <div class="title">{g.title}</div>
                  {g.release_year ? <div class="year">{g.release_year}</div> : null}
                  <div class="tags">
                    {g.player_status ? <span class="tag">{labelize(g.player_status)}</span> : null}
                    {g.game_status ? <span class="tag">{labelize(g.game_status)}</span> : null}
                    {genres.map((name) => <span class="tag">{name}</span>)}
                    {engines.map((name) => <span class="tag">{name}</span>)}
                  </div>
                </div>
              </a>
            </div>
          );
        })}
      </div>
  </main>
</BaseLayout>
