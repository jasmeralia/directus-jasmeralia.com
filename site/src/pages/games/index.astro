---
import BaseLayout from "../../layouts/BaseLayout.astro";
import CsvHeader from "../../components/CsvHeader.astro";
import GameThumbCard from "../../components/GameThumbCard.astro";
import { directusFetchItems } from "../../lib/directus";
import { csvDataUri, gamesToCsv } from "../../lib/csv";
import { GAME_THUMB_FIELDS } from "../../lib/game-fields";

const games = await directusFetchItems('games', {
  fields: GAME_THUMB_FIELDS,
  sort: ['sort', 'title'],
  limit: 500,
});

const gameIds = games.map((game) => game.id).filter((id) => typeof id === "number");
const reviewedGameIds = new Set();
if (gameIds.length) {
  const reviews = await directusFetchItems("reviews", {
    fields: ["game.id"],
    filter: { status: { _eq: "published" }, game: { _in: gameIds } },
    limit: 500,
  });
  for (const review of reviews ?? []) {
    const id = review?.game?.id;
    if (typeof id === "number") reviewedGameIds.add(id);
  }
}

const csvName = "games.csv";
const csvHref = csvDataUri(gamesToCsv(games));

---

<BaseLayout title="Games">
  <div slot="head">
    <style>
      main{padding:2rem;}
      .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;}
    </style>
  </div>
  <main>
      <CsvHeader title="Games" count={games.length} csvHref={csvHref} csvName={csvName} />
      <p style="opacity:.75;margin-top:0;">Gold borders indicate games with reviews. Silver borders indicate completed player status.</p>
      <div class="grid">
        {games.map((g) => {
          const reviewed = reviewedGameIds.has(g.id);
          return (
            <GameThumbCard game={g} reviewed={reviewed} />
          );
        })}
      </div>
  </main>
</BaseLayout>
