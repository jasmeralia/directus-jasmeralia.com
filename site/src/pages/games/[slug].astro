---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { directusFetchItems, fileUrl } from '../../lib/directus';
import { formatDate } from "../../lib/date";
import { getDownloadLinkMeta } from "../../lib/download-link";

export async function getStaticPaths() {
  const games = await directusFetchItems('games', {
    fields: ['slug'],
    limit: 500,
    sort: ['sort', 'title'],
  });

  return games
    .filter((g) => !!g.slug)
    .map((g) => ({ params: { slug: g.slug } }));
}

const { slug } = Astro.params;

const games = await directusFetchItems('games', {
  fields: [
    'id',
    'title',
    'slug',
    'release_year',
    'download_url',
    'gamestorylog_url',
    'walkthrough_url',
    'player_status',
    'game_status',
    'cover_image.id',
    'cover_image.filename_disk',
    'genres.id',
    'genres.genres_id.id',
    'genres.genres_id.name',
    'genres.genres_id.slug',
    'engines.id',
    'engines.engines_id.id',
    'engines.engines_id.title',
    'engines.engines_id.slug',
    'developers.id',
    'developers.developers_id.id',
    'developers.developers_id.name',
    'developers.developers_id.slug',
  ],
  filter: { slug: { _eq: slug } },
  limit: 1,
});

const game = games?.[0];
if (!game) {
  throw new Error(`Game not found for slug: ${slug}`);
}

const cover = fileUrl(game.cover_image);
const labelize = (value) => value ? value.replace(/_/g, " ").replace(/\b\w/g, (c) => c.toUpperCase()) : "";
const tierLabel = (value) => value === "U" ? "Too Early" : (value ?? "");
const genres = (game.genres ?? [])
  .map((genre) => genre?.genres_id)
  .filter((value) => value && value.name && value.slug);
const engines = (game.engines ?? [])
  .map((engine) => engine?.engines_id)
  .filter((value) => value && value.title && value.slug);
const developers = (game.developers ?? [])
  .map((developer) => developer?.developers_id)
  .filter((value) => value && (value.name || value.title) && value.slug)
  .sort((a, b) => (a.name ?? a.title ?? "").localeCompare(b.name ?? b.title ?? ""));
const reviews = await directusFetchItems('reviews', {
  fields: ['id', 'title', 'slug', 'published_at'],
  filter: { status: { _eq: "published" }, game: { _eq: game.id } },
  sort: ['-published_at'],
  limit: 100,
});
const tierEntries = await directusFetchItems('tier_entries', {
  fields: [
    'id',
    'tier_row.id',
    'tier_row.label',
    'tier_row.tier_list.id',
    'tier_row.tier_list.title',
    'tier_row.tier_list.slug',
  ],
  filter: { game: { _eq: game.id }, tier_row: { tier_list: { status: { _eq: "published" } } } },
  sort: ['tier_row.tier_list.title'],
  limit: 200,
});
const tierListsMap = new Map();
for (const entry of (tierEntries ?? [])) {
  const row = entry?.tier_row;
  const list = row?.tier_list;
  if (!list?.slug || !list?.title) continue;
  if (!tierListsMap.has(list.slug)) {
    tierListsMap.set(list.slug, { slug: list.slug, title: list.title, label: row?.label ?? "" });
  }
}
const tierLists = Array.from(tierListsMap.values())
  .sort((a, b) => a.title.localeCompare(b.title));
const downloadLinkMeta = getDownloadLinkMeta(game.download_url);
const downloadLinkText =
  downloadLinkMeta.label === "Download"
    ? "Download"
    : `Download from ${downloadLinkMeta.label}`;
const walkthroughValue = typeof game.walkthrough_url === "string" ? game.walkthrough_url.trim() : "";
const hasThirdPartyWalkthrough = /^https?:\/\//i.test(walkthroughValue);
const walkthroughLinkMeta = getDownloadLinkMeta(walkthroughValue);
const walkthroughLinkText =
  walkthroughLinkMeta.label === "Download"
    ? "Walkthrough"
    : `Walkthrough on ${walkthroughLinkMeta.label}`;
---

<BaseLayout title={`Games | ${game.title}`}>
  <div slot="head">
    <style>
      .container { max-width: 1100px; margin: 0 auto; padding: 1.25rem; }
      .header { display: flex; gap: 1rem; align-items: center; }
      .cover { width: 320px; background: #000; border: 1px solid #2b2b2b; border-radius: 10px; padding: 10px; }
      .cover img { width: 100%; height: auto; object-fit: contain; display: block; }
      .meta { opacity: 0.9; }
      .section{margin-top:1.5rem;}
      .label{opacity:.7;font-size:.85rem;text-transform:uppercase;letter-spacing:.08em;}
      .panel{background:#111;border:1px solid #222;border-radius:12px;padding:16px;}
      .panel a{color:#9aa6ff;}
      .panel a:visited{color:#9aa6ff;}
      .meta a{color:#9aa6ff;}
      .meta a:visited{color:#9aa6ff;}
      .download-link{display:inline-flex;align-items:center;gap:.45rem;}
      .download-link img{width:1rem;height:1rem;display:block;filter:brightness(0) saturate(100%) invert(67%) sepia(11%) saturate(1832%) hue-rotate(194deg) brightness(97%) contrast(96%);}
    </style>
  </div>
  <main class="container">
      <section class="header">
        <div class="cover">
          {cover ? <img src={cover} alt={game.title} loading="lazy" /> : null}
        </div>
        <div>
          <h1>{game.title}</h1>
                    {game.download_url || game.gamestorylog_url ? (
            <div class="meta">
              {game.download_url ? (
                <div>
                  <a class="download-link" href={game.download_url} rel="noopener noreferrer" target="_blank">
                    {downloadLinkMeta.icon ? (
                      <img src={downloadLinkMeta.icon} alt="" aria-hidden="true" loading="lazy" />
                    ) : null}
                    <span>{downloadLinkText}</span>
                  </a>
                </div>
              ) : null}
              {game.gamestorylog_url ? (
                <div>
                  <a class="download-link" href={game.gamestorylog_url} rel="noopener noreferrer" target="_blank">
                    <img src="/icons/gamestorylog.png" alt="" aria-hidden="true" loading="lazy" />
                    <span>View on GameStoryLog</span>
                  </a>
                </div>
              ) : null}
            </div>
          ) : null}
        </div>
      </section>

      <div class="section panel">
        <div class="label">Details</div>
        <ul>
          {developers.length ? (
            <li>
              <strong>Developers:</strong> {developers.map((developer, index) => (
                <span>
                  <a href={`/developers/${developer.slug}/index.html`}>{developer.name ?? developer.title}</a>
                  {index < developers.length - 1 ? ", " : ""}
                </span>
              ))}
            </li>
          ) : null}
          {engines.length ? (
            <li>
              <strong>Engines:</strong> {engines.map((engine, index) => (
                <span>
                  <a href={`/engines/${engine.slug}/index.html`}>{engine.title}</a>
                  {index < engines.length - 1 ? ", " : ""}
                </span>
              ))}
            </li>
          ) : null}
          {game.game_status ? (
            <li>
              <strong>Game status:</strong> <a href={`/game_statuses/${game.game_status}/index.html`}>{labelize(game.game_status)}</a>
            </li>
          ) : null}
          {genres.length ? (
            <li>
              <strong>Genres:</strong> {genres.map((genre, index) => (
                <span>
                  <a href={`/genres/${genre.slug}/index.html`}>{genre.name}</a>
                  {index < genres.length - 1 ? ", " : ""}
                </span>
              ))}
            </li>
          ) : null}
          {game.player_status ? (
            <li>
              <strong>Player status:</strong> <a href={`/played_statuses/${game.player_status}/index.html`}>{labelize(game.player_status)}</a>
            </li>
          ) : null}
          {game.release_year ? (
            <li>
              <strong>Release year:</strong>{" "}
              <a href={`/releases/${game.release_year}/index.html`}>{game.release_year}</a>
            </li>
          ) : null}
          {tierLists.length ? (
            <li>
              <strong>Tier lists:</strong> {tierLists.map((tier, index) => (
                <span>
                  <a href={`/tiers/${tier.slug}/index.html`}>{tier.title}</a>
                  {tier.label ? ` (${tierLabel(tier.label)})` : ""}
                  {index < tierLists.length - 1 ? ", " : ""}
                </span>
              ))}
            </li>
          ) : null}
          {walkthroughValue ? (
            <li>
              <strong>Walkthrough:</strong>{" "}
              {hasThirdPartyWalkthrough ? (
                <a class="download-link" href={walkthroughValue} rel="noopener noreferrer" target="_blank">
                  {walkthroughLinkMeta.icon ? (
                    <img src={walkthroughLinkMeta.icon} alt="" aria-hidden="true" loading="lazy" />
                  ) : null}
                  <span>{walkthroughLinkText}</span>
                </a>
              ) : (
                <span>{walkthroughValue}</span>
              )}
            </li>
          ) : null}
        </ul>
      </div>

      {reviews.length ? (
        <div class="section panel">
          <div class="label">Reviews</div>
          <ul>
            {reviews.map((review) => (
              <li>
                <a href={`/reviews/${review.slug}/index.html`}>{review.title}</a>
                {review.published_at ? (
                  <span style="opacity:.7;margin-left:.5rem;">({formatDate(review.published_at)})</span>
                ) : null}
              </li>
            ))}
          </ul>
        </div>
      ) : null}
  </main>
</BaseLayout>
