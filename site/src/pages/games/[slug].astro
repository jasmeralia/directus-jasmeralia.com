---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { directusFetchItems, fileUrl } from '../../lib/directus';
import { formatDate } from "../../lib/date";

export async function getStaticPaths() {
  const games = await directusFetchItems('games', {
    fields: ['slug'],
    limit: 500,
    sort: ['sort', 'title'],
  });

  return games
    .filter((g) => !!g.slug)
    .map((g) => ({ params: { slug: g.slug } }));
}

const { slug } = Astro.params;

const games = await directusFetchItems('games', {
  fields: [
    'id',
    'title',
    'slug',
    'release_year',
    'download_url',
    'player_status',
    'game_status',
    'cover_image.id',
    'cover_image.filename_disk',
    'genres.id',
    'genres.genres_id.id',
    'genres.genres_id.name',
    'genres.genres_id.slug',
    'engines.id',
    'engines.engines_id.id',
    'engines.engines_id.title',
    'engines.engines_id.slug',
  ],
  filter: { slug: { _eq: slug } },
  limit: 1,
});

const game = games?.[0];
if (!game) {
  throw new Error(`Game not found for slug: ${slug}`);
}

const cover = fileUrl(game.cover_image);
const labelize = (value) => value ? value.replace(/_/g, " ").replace(/\b\w/g, (c) => c.toUpperCase()) : "";
const genres = (game.genres ?? [])
  .map((genre) => genre?.genres_id)
  .filter((value) => value && value.name && value.slug);
const engines = (game.engines ?? [])
  .map((engine) => engine?.engines_id)
  .filter((value) => value && value.title && value.slug);
const reviews = await directusFetchItems('reviews', {
  fields: ['id', 'title', 'slug', 'published_at'],
  filter: { status: { _eq: "published" }, game: { _eq: game.id } },
  sort: ['-published_at'],
  limit: 100,
});
---

<BaseLayout title={game.title}>
  <div slot="head">
    <style>
      .container { max-width: 1100px; margin: 0 auto; padding: 1.25rem; }
      .header { display: flex; gap: 1rem; align-items: center; }
      .cover { width: 320px; background: #000; border: 1px solid #2b2b2b; border-radius: 10px; padding: 10px; }
      .cover img { width: 100%; height: auto; object-fit: contain; display: block; }
      .meta { opacity: 0.9; }
      .section{margin-top:1.5rem;}
      .label{opacity:.7;font-size:.85rem;text-transform:uppercase;letter-spacing:.08em;}
    </style>
  </div>
  <main class="container">
      <section class="header">
        <div class="cover">
          {cover ? <img src={cover} alt={game.title} loading="lazy" /> : null}
        </div>
        <div>
          <h1>{game.title}</h1>
                    {game.download_url ? (
            <div class="meta">
              <a href={game.download_url} rel="noopener noreferrer" target="_blank">Download</a>
            </div>
          ) : null}
        </div>
      </section>

      <div class="section">
        <div class="label">Details</div>
        <ul>
          {game.release_year ? <li>Release year: {game.release_year}</li> : null}
          {game.player_status ? <li>Player status: {labelize(game.player_status)}</li> : null}
          {game.game_status ? (
            <li>
              Game status: <a href={`/game_statuses/${game.game_status}/index.html`}>{labelize(game.game_status)}</a>
            </li>
          ) : null}
          {genres.length ? (
            <li>
              Genres: {genres.map((genre, index) => (
                <span>
                  <a href={`/genres/${genre.slug}/index.html`}>{genre.name}</a>
                  {index < genres.length - 1 ? ", " : ""}
                </span>
              ))}
            </li>
          ) : null}
          {engines.length ? (
            <li>
              Engines: {engines.map((engine, index) => (
                <span>
                  <a href={`/engines/${engine.slug}/index.html`}>{engine.title}</a>
                  {index < engines.length - 1 ? ", " : ""}
                </span>
              ))}
            </li>
          ) : null}
        </ul>
      </div>

      {reviews.length ? (
        <div class="section">
          <div class="label">Reviews</div>
          <ul>
            {reviews.map((review) => (
              <li>
                <a href={`/reviews/${review.slug}/index.html`}>{review.title}</a>
                {review.published_at ? (
                  <span style="opacity:.7;margin-left:.5rem;">({formatDate(review.published_at)})</span>
                ) : null}
              </li>
            ))}
          </ul>
        </div>
      ) : null}
  </main>
</BaseLayout>
