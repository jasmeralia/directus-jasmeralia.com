---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { directusFetchItems } from "../../lib/directus";
import { compareLabels, formatUnknown } from "../../lib/list-format";

const engines = await directusFetchItems("engines", {
  fields: ["id", "title", "slug", "engine_type"],
  sort: ["title"],
  limit: 500,
});
const sortedEngines = [...engines].sort((a, b) =>
  compareLabels(a.title ?? "", b.title ?? ""),
);
const unknownLabel = formatUnknown("unknown", "Engine");
const games = await directusFetchItems("games", {
  fields: ["id", "engines.engines_id.slug", "engines.engines_id.engine_type"],
  limit: 1000,
});
const engineCounts = new Map();
let unknownCount = 0;
for (const game of games) {
  const entries = game.engines ?? [];
  if (!entries.length) {
    unknownCount += 1;
    continue;
  }
  for (const entry of entries) {
    const slug = entry?.engines_id?.slug;
    if (!slug) continue;
    engineCounts.set(slug, (engineCounts.get(slug) || 0) + 1);
  }
}

const renderEngines = engines.filter((engine) => engine.engine_type === "rendering");
const gamingEngines = engines.filter((engine) => engine.engine_type === "gaming");

const pieColors = ["#d3a43b", "#4aa3ff", "#7fe29a", "#ff7a7a", "#c788ff", "#ffd966", "#7bd3ff", "#e6a8ff"];
const buildPie = (items) => {
  const segments = items.map((item, index) => ({
    title: item.title,
    value: item.slug === "__unknown__" ? unknownCount : (engineCounts.get(item.slug) || 0),
    color: pieColors[index % pieColors.length],
  }));
  const total = segments.reduce((sum, segment) => sum + segment.value, 0);
  return { segments, total };
};
const size = 180;
const radius = 84;
const cx = size / 2;
const cy = size / 2;
const polarToCartesian = (centerX, centerY, radiusValue, angleInDegrees) => {
  const angleInRadians = ((angleInDegrees - 90) * Math.PI) / 180.0;
  return {
    x: centerX + radiusValue * Math.cos(angleInRadians),
    y: centerY + radiusValue * Math.sin(angleInRadians),
  };
};
const describeArc = (x, y, radiusValue, startAngle, endAngle) => {
  const start = polarToCartesian(x, y, radiusValue, endAngle);
  const end = polarToCartesian(x, y, radiusValue, startAngle);
  const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
  return [
    "M",
    x,
    y,
    "L",
    start.x,
    start.y,
    "A",
    radiusValue,
    radiusValue,
    0,
    largeArcFlag,
    0,
    end.x,
    end.y,
    "Z",
  ].join(" ");
};
const buildArcSegments = (items, total) => {
  if (!total) return [];
  const result = [];
  let startAngle = 0;
  for (const segment of items) {
    if (!segment.value) continue;
    const angle = (segment.value / total) * 360;
    const endAngle = startAngle + angle;
    result.push({
      ...segment,
      startAngle,
      endAngle,
    });
    startAngle = endAngle;
  }
  return result;
};

const renderingPie = buildPie(renderEngines);
const unknownEngineItem = unknownCount > 0 ? [{ title: formatUnknown("unknown", "Engine"), slug: "__unknown__" }] : [];
const gamingPie = buildPie([...gamingEngines, ...unknownEngineItem]);
const renderingArcs = buildArcSegments(renderingPie.segments, renderingPie.total);
const gamingArcs = buildArcSegments(gamingPie.segments, gamingPie.total);
---

<BaseLayout title="Engines">
  <div slot="head">
    <style>
      main{max-width:980px;margin:0 auto;padding:24px;}
      ul{list-style:disc;padding-left:20px;}
      .panel{background:#111;border:1px solid #222;border-radius:12px;padding:16px;}
      .panel a{color:#9aa6ff;}
      .panel a:visited{color:#9aa6ff;}
      .charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-top:16px;}
      .chart{display:flex;flex-direction:column;gap:8px;align-items:flex-start;}
      .pie{width:180px;height:180px;border-radius:50%;border:1px solid #2b2b2b;display:block;}
      .legend{list-style:none;padding:0;margin:0;}
      .legend li{display:flex;align-items:center;gap:8px;font-size:.9rem;}
      .swatch{width:12px;height:12px;border-radius:3px;display:inline-block;}
    </style>
  </div>
  <main>
      <div class="panel">
        <h1>Engines</h1>
        {engines.length === 0 ? (
          <p>No engines yet.</p>
        ) : (
          <ul>
          {sortedEngines.map((engine) => (
            <li>
              <a href={`/engines/${engine.slug}/index.html`}>{engine.title}</a>
              <span style="opacity:.7;"> ({engineCounts.get(engine.slug) || 0})</span>
            </li>
          ))}
          {unknownCount > 0 ? (
            <li>
              <a href="/engines/unknown/index.html">{unknownLabel}</a>
              <span style="opacity:.7;"> ({unknownCount})</span>
            </li>
          ) : null}
        </ul>
      )}
        <div class="charts">
          <div class="chart">
            <strong>Rendering Engines</strong>
            <svg class="pie" viewBox={`0 0 ${size} ${size}`} role="img" aria-label="Rendering engines breakdown">
              {renderingArcs.length === 0 ? (
                <circle cx={cx} cy={cy} r={radius} fill="#222" />
              ) : renderingArcs.length === 1 ? (
                <circle cx={cx} cy={cy} r={radius} fill={renderingArcs[0].color}>
                  <title>{renderingArcs[0].title} ({renderingArcs[0].value})</title>
                </circle>
              ) : (
                renderingArcs.map((segment) => (
                  <path d={describeArc(cx, cy, radius, segment.startAngle, segment.endAngle)} fill={segment.color}>
                    <title>{segment.title} ({segment.value})</title>
                  </path>
                ))
              )}
            </svg>
            <ul class="legend">
              {renderingPie.segments.map((segment) => (
                <li>
                  <span class="swatch" style={`background:${segment.color};`}></span>
                  {segment.title} ({segment.value})
                </li>
              ))}
            </ul>
          </div>
          <div class="chart">
            <strong>Gaming Engines</strong>
            <svg class="pie" viewBox={`0 0 ${size} ${size}`} role="img" aria-label="Gaming engines breakdown">
              {gamingArcs.length === 0 ? (
                <circle cx={cx} cy={cy} r={radius} fill="#222" />
              ) : gamingArcs.length === 1 ? (
                <circle cx={cx} cy={cy} r={radius} fill={gamingArcs[0].color}>
                  <title>{gamingArcs[0].title} ({gamingArcs[0].value})</title>
                </circle>
              ) : (
                gamingArcs.map((segment) => (
                  <path d={describeArc(cx, cy, radius, segment.startAngle, segment.endAngle)} fill={segment.color}>
                    <title>{segment.title} ({segment.value})</title>
                  </path>
                ))
              )}
            </svg>
            <ul class="legend">
              {gamingPie.segments.map((segment) => (
                <li>
                  <span class="swatch" style={`background:${segment.color};`}></span>
                  {segment.title} ({segment.value})
                </li>
              ))}
            </ul>
          </div>
        </div>
      </div>
  </main>
</BaseLayout>
