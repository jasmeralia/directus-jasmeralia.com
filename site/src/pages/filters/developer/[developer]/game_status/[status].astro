---
import BaseLayout from "../../../../../layouts/BaseLayout.astro";
import CsvHeader from "../../../../../components/CsvHeader.astro";
import GameThumbCard from "../../../../../components/GameThumbCard.astro";
import { directusFetchItems, getSTierGameIds } from "../../../../../lib/directus";
import { csvDataUri, gamesToCsv } from "../../../../../lib/csv";
import { GAME_THUMB_FIELDS } from "../../../../../lib/game-fields";

export async function getStaticPaths() {
  const games = await directusFetchItems("games", {
    fields: ["id", "game_status", "developers.developers_id.slug"],
    limit: 1000,
  });

  const comboCounts = new Map();
  const developerStatusValues = new Map();
  for (const game of games ?? []) {
    if (!game.game_status) continue;
    const developerSlugs =
      (game.developers ?? []).map((entry) => entry?.developers_id?.slug).filter(Boolean);
    const developersForGame = developerSlugs.length ? developerSlugs : ["unknown"];
    for (const developer of developersForGame) {
      const key = `${developer}::${game.game_status}`;
      comboCounts.set(key, (comboCounts.get(key) || 0) + 1);
      if (!developerStatusValues.has(developer)) {
        developerStatusValues.set(developer, new Set());
      }
      developerStatusValues.get(developer).add(game.game_status);
    }
  }

  return Array.from(comboCounts.keys())
    .filter((key) => {
      const [developer] = key.split("::");
      return (developerStatusValues.get(developer)?.size ?? 0) > 1;
    })
    .map((key) => {
      const [developer, status] = key.split("::");
      return { params: { developer, status } };
    });
}

const { developer, status } = Astro.params;
const labelize = (value) =>
  value ? value.replace(/_/g, " ").replace(/\b\w/g, (c) => c.toUpperCase()) : "";

const developers = await directusFetchItems("developers", {
  fields: ["slug", "name"],
  filter: { slug: { _eq: developer } },
  limit: 1,
});
const developerLabel =
  developer === "unknown"
    ? "Unknown"
    : (developers?.[0]?.name ?? developer);
const statusLabel = labelize(status);

const filter = { game_status: { _eq: status } };
if (developer !== "unknown") {
  filter.developers = { developers_id: { slug: { _eq: developer } } };
}

let games = await directusFetchItems("games", {
  fields: [...GAME_THUMB_FIELDS, "developers.id"],
  filter,
  sort: ["title"],
  limit: 1000,
});

if (developer === "unknown") {
  games = games.filter((game) => (game.developers ?? []).length === 0);
}

const gameIds = games.map((game) => game.id).filter((id) => typeof id === "number");
const reviewedGameIds = new Set();
if (gameIds.length) {
  const reviews = await directusFetchItems("reviews", {
    fields: ["game.id"],
    filter: { status: { _eq: "published" }, game: { _in: gameIds } },
    limit: 500,
  });
  for (const review of reviews ?? []) {
    const id = review?.game?.id;
    if (typeof id === "number") reviewedGameIds.add(id);
  }
}
const sTierGameIds = await getSTierGameIds(gameIds);

const csvName = `developer-${developer}-game-status-${status}.csv`;
const csvHref = csvDataUri(gamesToCsv(games));
---

<BaseLayout title={`Filters | ${developerLabel} + ${statusLabel}`}>
  <div slot="head">
    <style>
      main{padding:2rem;}
      .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;}
      .panel{background:#111;border:1px solid #222;border-radius:12px;padding:16px;margin-bottom:16px;}
      .panel a{color:#9aa6ff;}
      .panel a:visited{color:#9aa6ff;}
    </style>
  </div>
  <main>
    <div class="panel">
      <CsvHeader title={`${developerLabel} + ${statusLabel}`} count={games.length} csvHref={csvHref} csvName={csvName} />
      <p>
        Developer: <strong>{developerLabel}</strong> &nbsp;|&nbsp;
        Game status: <strong>{statusLabel}</strong>
      </p>
    </div>
    {games.length === 0 ? (
      <p>No games found for this combination.</p>
    ) : (
      <div class="grid">
        {games.map((game) => {
          const reviewed = reviewedGameIds.has(game.id);
          const sTier = sTierGameIds.has(game.id);
          return <GameThumbCard game={game} reviewed={reviewed} sTier={sTier} />;
        })}
      </div>
    )}
  </main>
</BaseLayout>
