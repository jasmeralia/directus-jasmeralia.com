---
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import CsvHeader from "../../../../components/CsvHeader.astro";
import ThumbnailBorderLegend from "../../../../components/ThumbnailBorderLegend.astro";
import GameThumbCard from "../../../../components/GameThumbCard.astro";
import { directusFetchItems, getSTierGameIds } from "../../../../lib/directus";
import { csvDataUri, gamesToCsv } from "../../../../lib/csv";
import { GAME_THUMB_FIELDS } from "../../../../lib/game-fields";
import {
  classifyWalkthroughValue,
  WALKTHROUGH_KIND_LABEL,
  type WalkthroughKind,
} from "../../../../lib/walkthrough-link";

const walkthroughKinds: WalkthroughKind[] = [
  "steam",
  "itch",
  "gog",
  "patreon",
  "unknown",
  "text-note",
  "none-provided",
];

export async function getStaticPaths() {
  const kinds: WalkthroughKind[] = [
    "steam",
    "itch",
    "gog",
    "patreon",
    "unknown",
    "text-note",
    "none-provided",
  ];
  return kinds.map((kind) => ({ params: { kind } }));
}

const { kind } = Astro.params;
if (!walkthroughKinds.includes(kind as WalkthroughKind)) {
  throw new Error(`Unsupported walkthrough filter: ${kind}`);
}

const games = await directusFetchItems("games", {
  fields: GAME_THUMB_FIELDS,
  sort: ["title"],
  limit: 1000,
});
const filteredGames = (games ?? []).filter(
  (game) => classifyWalkthroughValue(game?.walkthrough_url) === kind,
);

const gameIds = filteredGames
  .map((game) => game.id)
  .filter((id) => typeof id === "number");
const sTierGameIds = await getSTierGameIds(gameIds);
const reviewedGameIds = new Set();
if (gameIds.length) {
  const reviews = await directusFetchItems("reviews", {
    fields: ["game.id"],
    filter: { status: { _eq: "published" }, game: { _in: gameIds } },
    limit: 500,
  });
  for (const review of reviews ?? []) {
    const id = review?.game?.id;
    if (typeof id === "number") reviewedGameIds.add(id);
  }
}

const walkthroughLabel = WALKTHROUGH_KIND_LABEL[kind as WalkthroughKind];
const csvName = `walkthrough-url-${kind}.csv`;
const csvHref = csvDataUri(gamesToCsv(filteredGames));
---

<BaseLayout title={`Filters | Walkthrough URL + ${walkthroughLabel}`}>
  <div slot="head">
    <style>
      main{padding:2rem;}
      .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;}
      .panel{background:#111;border:1px solid #222;border-radius:12px;padding:16px;margin-bottom:16px;}
      .panel a{color:#9aa6ff;}
      .panel a:visited{color:#9aa6ff;}
    </style>
  </div>
  <main>
    <div class="panel">
      <CsvHeader title={`Walkthrough URL + ${walkthroughLabel}`} count={filteredGames.length} csvHref={csvHref} csvName={csvName} />
      <p>Games where walkthrough URL classification is {walkthroughLabel}.</p>
    </div>
    <ThumbnailBorderLegend />
    {filteredGames.length === 0 ? (
      <p>No games found for this walkthrough category.</p>
    ) : (
      <div class="grid">
        {filteredGames.map((game) => {
          const reviewed = reviewedGameIds.has(game.id);
          const sTier = sTierGameIds.has(game.id);
          return <GameThumbCard game={game} reviewed={reviewed} sTier={sTier} />;
        })}
      </div>
    )}
  </main>
</BaseLayout>
