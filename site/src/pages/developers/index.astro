---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { directusFetchItems } from "../../lib/directus";
import { compareLabels, formatUnknown } from "../../lib/list-format";

const developers = await directusFetchItems("developers", {
  fields: ["id", "name", "slug"],
  sort: ["name"],
  limit: 500,
});
const sortedDevelopers = [...developers].sort((a, b) =>
  compareLabels(a.name ?? "", b.name ?? ""),
);
const unknownLabel = formatUnknown("unknown", "Developer");
const games = await directusFetchItems("games", {
  fields: ["id", "developers.developers_id.slug"],
  limit: 1000,
});
const developerCounts = new Map();
let unknownCount = 0;
for (const game of games) {
  const entries = game.developers ?? [];
  if (!entries.length) {
    unknownCount += 1;
    continue;
  }
  for (const entry of entries) {
    const slug = entry?.developers_id?.slug;
    if (!slug) continue;
    developerCounts.set(slug, (developerCounts.get(slug) || 0) + 1);
  }
}
---

<BaseLayout title="Developers">
  <div slot="head">
    <style>
      main{max-width:980px;margin:0 auto;padding:24px;}
      ul{list-style:disc;padding-left:20px;}
      .panel{background:#111;border:1px solid #222;border-radius:12px;padding:16px;}
      .panel a{color:#9aa6ff;}
      .panel a:visited{color:#9aa6ff;}
    </style>
  </div>
  <main>
    <div class="panel">
      <h1>Developers</h1>
      {developers.length === 0 ? (
        <p>No developers yet.</p>
      ) : (
        <ul>
          {sortedDevelopers.map((developer) => (
            <li>
              <a href={`/developers/${developer.slug}/index.html`}>{developer.name}</a>
              <span style="opacity:.7;"> ({developerCounts.get(developer.slug) || 0})</span>
            </li>
          ))}
          {unknownCount > 0 ? (
            <li>
              <a href="/developers/unknown/index.html">{unknownLabel}</a>
              <span style="opacity:.7;"> ({unknownCount})</span>
            </li>
          ) : null}
        </ul>
      )}
    </div>
  </main>
</BaseLayout>
