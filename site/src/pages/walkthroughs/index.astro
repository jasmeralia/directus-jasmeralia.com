---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { directusFetchItems } from "../../lib/directus";
import { getDownloadLinkMeta } from "../../lib/download-link";

const games = await directusFetchItems("games", {
  fields: ["id", "title", "slug", "walkthrough_url"],
  filter: {
    walkthrough_url: { _null: false, _nempty: true },
  },
  sort: ["title"],
  limit: 1000,
});
const isUrl = (value) => typeof value === "string" && /^https?:\/\//i.test(value.trim());
const walkthroughMeta = (url) => {
  const meta = getDownloadLinkMeta(url);
  return {
    ...meta,
    text: meta.label === "Download" ? "Walkthrough" : `Walkthrough on ${meta.label}`,
  };
};
---

<BaseLayout title="Walkthroughs">
  <div slot="head">
    <style>
      main{max-width:980px;margin:0 auto;padding:24px;}
      ul{list-style:disc;padding-left:20px;}
      .panel{background:#111;border:1px solid #222;border-radius:12px;padding:16px;}
      .panel a{color:#9aa6ff;}
      .panel a:visited{color:#9aa6ff;}
      .ext-link{display:inline-flex;align-items:center;gap:.45rem;}
      .ext-link img{width:1rem;height:1rem;display:block;filter:brightness(0) saturate(100%) invert(67%) sepia(11%) saturate(1832%) hue-rotate(194deg) brightness(97%) contrast(96%);}
    </style>
  </div>
  <main>
      <div class="panel">
        <h1>Walkthroughs</h1>
        {games.length === 0 ? (
          <p>No walkthroughs yet.</p>
        ) : (
          <ul>
            {games.map((game) => (
              <li>
                <a href={`/games/${game.slug}/index.html`}>{game.title}</a>:{" "}
                {isUrl(game.walkthrough_url) ? (
                  (() => {
                    const meta = walkthroughMeta(game.walkthrough_url);
                    return (
                      <a class="ext-link" href={game.walkthrough_url} rel="noopener noreferrer" target="_blank">
                        {meta.icon ? (
                          <img src={meta.icon} alt="" aria-hidden="true" loading="lazy" />
                        ) : null}
                        <span>{meta.text}</span>
                      </a>
                    );
                  })()
                ) : <span>{game.walkthrough_url}</span>}
              </li>
            ))}
          </ul>
        )}
      </div>
  </main>
</BaseLayout>
