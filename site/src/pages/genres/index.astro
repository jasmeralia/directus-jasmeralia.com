---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { directusFetchItems } from "../../lib/directus";

const genres = await directusFetchItems("genres", {
  fields: ["id", "name", "slug"],
  sort: ["name"],
  limit: 500,
});
const games = await directusFetchItems("games", {
  fields: ["id", "genres.genres_id.slug"],
  limit: 1000,
});
const genreCounts = new Map();
for (const game of games) {
  for (const entry of game.genres ?? []) {
    const slug = entry?.genres_id?.slug;
    if (!slug) continue;
    genreCounts.set(slug, (genreCounts.get(slug) || 0) + 1);
  }
}
---

<BaseLayout title="Genres">
  <div slot="head">
    <style>
      main{max-width:980px;margin:0 auto;padding:24px;}
      ul{list-style:disc;padding-left:20px;}
    </style>
  </div>
  <main>
      <h1>Genres</h1>
      {genres.length === 0 ? (
        <p>No genres yet.</p>
      ) : (
        <ul>
          {genres.map((genre) => (
            <li>
              <a href={`/genres/${genre.slug}/index.html`}>{genre.name}</a>
              <span style="opacity:.7;"> ({genreCounts.get(genre.slug) || 0})</span>
            </li>
          ))}
        </ul>
      )}
  </main>
</BaseLayout>
