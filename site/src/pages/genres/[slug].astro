---
import BaseLayout from "../../layouts/BaseLayout.astro";
import CsvHeader from "../../components/CsvHeader.astro";
import GameThumbCard from "../../components/GameThumbCard.astro";
import { directusFetchItems } from "../../lib/directus";
import { csvDataUri, gamesToCsv } from "../../lib/csv";
import { GAME_THUMB_FIELDS } from "../../lib/game-fields";

export async function getStaticPaths() {
  const genres = await directusFetchItems("genres", {
    fields: ["slug"],
    limit: 500,
    sort: ["name"],
  });

  return genres
    .filter((genre) => !!genre.slug)
    .map((genre) => ({ params: { slug: genre.slug } }))
    .concat([{ params: { slug: "unknown" } }]);
}

const { slug } = Astro.params;
const isUnknown = slug === "unknown";

let title = "Unknown";
let games = [];

if (isUnknown) {
  const allGames = await directusFetchItems("games", {
    fields: GAME_THUMB_FIELDS,
    sort: ["title"],
    limit: 1000,
  });
  games = allGames.filter((game) => (game.genres ?? []).length === 0);
} else {
  const genres = await directusFetchItems("genres", {
    fields: ["id", "name", "slug"],
    filter: { slug: { _eq: slug } },
    limit: 1,
  });

  const genre = genres?.[0];
  if (!genre) {
    throw new Error(`Genre not found for slug: ${slug}`);
  }
  title = genre.name;

  games = await directusFetchItems("games", {
    fields: GAME_THUMB_FIELDS,
    filter: { genres: { genres_id: { slug: { _eq: slug } } } },
    sort: ["title"],
    limit: 500,
  });
}

const gameIds = games.map((game) => game.id).filter((id) => typeof id === "number");
const reviewedGameIds = new Set();
if (gameIds.length) {
  const reviews = await directusFetchItems("reviews", {
    fields: ["game.id"],
    filter: { status: { _eq: "published" }, game: { _in: gameIds } },
    limit: 500,
  });
  for (const review of reviews ?? []) {
    const id = review?.game?.id;
    if (typeof id === "number") reviewedGameIds.add(id);
  }
}

const csvName = `genre-${slug}.csv`;
const csvHref = csvDataUri(gamesToCsv(games));
---

<BaseLayout title={`Genres | ${title}`}>
  <div slot="head">
    <style>
      main{padding:2rem;}
      .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;}
    </style>
  </div>
  <main>
      <CsvHeader title={title} count={games.length} csvHref={csvHref} csvName={csvName} />
      {games.length === 0 ? (
        <p>{isUnknown ? "No games have an unknown genre." : "No games found for this genre."}</p>
      ) : (
        <div class="grid">
          {games.map((g) => {
            const reviewed = reviewedGameIds.has(g.id);
            return (
              <GameThumbCard game={g} reviewed={reviewed} />
            );
          })}
        </div>
      )}
  </main>
</BaseLayout>
