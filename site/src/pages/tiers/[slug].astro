---
import BaseLayout from "../../layouts/BaseLayout.astro";
import ThumbnailBorderLegend from "../../components/ThumbnailBorderLegend.astro";
import { directusFetchItems, getPublishedTierListBySlug, listPublishedTierListSlugs, fileUrl } from "../../lib/directus";
import "../../styles/tierlist.css";

// Static generation: /tiers/<slug> for each published tier list
export async function getStaticPaths() {
  const slugs = await listPublishedTierListSlugs();
  return slugs.map((slug) => ({ params: { slug } }));
}

const { slug } = Astro.params;
if (!slug) throw new Error("Missing slug param");

const tierList = await getPublishedTierListBySlug(slug);
if (!tierList) return Astro.redirect("/404");

const gameIds = tierList.tier_rows
  .flatMap((row) => row.tier_entries ?? [])
  .map((entry) => entry?.game?.id)
  .filter((id) => typeof id === "number");

const reviewedGameIds = new Set();
if (gameIds.length) {
  const reviews = await directusFetchItems("reviews", {
    fields: ["game.id"],
    filter: { status: { _eq: "published" }, game: { _in: gameIds } },
    limit: 500,
  });
  for (const review of reviews ?? []) {
    const id = review?.game?.id;
    if (typeof id === "number") reviewedGameIds.add(id);
  }
}

const thumbBorderStyle = (reviewed, playerStatus, sTier) => {
  const completed = playerStatus === "completed";
  const didNotFinish = playerStatus === "did_not_finish";
  const inProgress = playerStatus === "in_progress";
  const statusColor = completed
    ? "#c0c0c0"
    : didNotFinish
      ? "#d14b4b"
      : inProgress
        ? "#70b7ff"
        : null;
  const innerBorderColor = statusColor ?? (!reviewed && !sTier ? "#2b2b2b" : "transparent");
  return `--inner-border:${innerBorderColor};`;
};
---

<BaseLayout title={`Tier Lists | ${tierList.title}`} description={tierList.description ?? tierList.title}>
<main class="tier-page">
      <h1 class="tier-title">{tierList.title}</h1>
      {tierList.description && <p class="tier-desc">{tierList.description}</p>}

      <section class="tier-board" aria-label="Tier list">
        {tierList.tier_rows.map((row) => (
          <div class="tier-row">
            <div class="tier-label" style={`background:${row.color};`}>
              {row.label === "U" ? "Too Early" : row.label}
            </div>

            <div class="tier-cells">
              {row.tier_entries.length === 0 ? (
                <div class="tier-empty">No entries</div>
              ) : (
                [...row.tier_entries]
                  .sort((a, b) => (a.game?.title || "").localeCompare(b.game?.title || ""))
                  .map((entry) => {
                  const img = fileUrl(entry.game.cover_image);
                  const reviewed = reviewedGameIds.has(entry.game.id);
                  const completed = entry.game?.player_status === "completed";
                  const didNotFinish = entry.game?.player_status === "did_not_finish";
                  const inProgress = entry.game?.player_status === "in_progress";
                  const sTier = row.label === "S";
                  const hasStatus = completed || didNotFinish || inProgress;
                  const layerCount = (sTier ? 1 : 0) + (reviewed ? 1 : 0) + (hasStatus ? 1 : 0);
                  const hasTwoLayers = layerCount === 2;
                  const hasThreeLayers = layerCount === 3;
                  return (
                    <div class={`tier-stack${reviewed ? " reviewed" : ""}${sTier ? " s-tier" : ""}${hasStatus ? " has-status" : ""}${hasTwoLayers ? " two-layers" : ""}${hasThreeLayers ? " three-layers" : ""}`}>
                      <div class="ring-rainbow">
                        <div class="gap-rainbow">
                          <div class="ring-gold">
                            <div class="gap-gold">
                              <a
                                class="tier-thumb"
                                href={`/games/${entry.game.slug}/index.html`}
                                title={entry.game.title}
                                style={thumbBorderStyle(reviewed, entry.game?.player_status, sTier)}
                              >
                                {img ? (
                                  <img src={img} alt={entry.game.title} loading="lazy" />
                                ) : (
                                  <span style="display:flex;align-items:center;justify-content:center;height:100%;color:#aaa;font-size:12px;">
                                    No image
                                  </span>
                                )}
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })
              )}
            </div>
          </div>
        ))}
      </section>
      <ThumbnailBorderLegend style="margin-top:1rem;" />
    </main>
</BaseLayout>
