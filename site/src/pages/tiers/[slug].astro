---
import BaseLayout from "../../layouts/BaseLayout.astro";
import type { APIContext } from "astro";
import { getPublishedTierListBySlug, listPublishedTierListSlugs, fileUrl } from "../../lib/directus";
import "../../styles/tierlist.css";

// Static generation: /tiers/<slug> for each published tier list
export async function getStaticPaths() {
  const slugs = await listPublishedTierListSlugs();
  return slugs.map((slug) => ({ params: { slug } }));
}

const { slug } = Astro.params;
if (!slug) throw new Error("Missing slug param");

const tierList = await getPublishedTierListBySlug(slug);
if (!tierList) return Astro.redirect("/404");
---

<BaseLayout title={tierList.title} description={tierList.description ?? tierList.title}>
<main class="tier-page">
      <h1 class="tier-title">{tierList.title}</h1>
      {tierList.description && <p class="tier-desc">{tierList.description}</p>}

      <section class="tier-board" aria-label="Tier list">
        {tierList.tier_rows.map((row) => (
          <div class="tier-row">
            <div class="tier-label" style={`background:${row.color};`}>
              {row.label}
            </div>

            <div class="tier-cells">
              {row.tier_entries.length === 0 ? (
                <div class="tier-empty">No entries</div>
              ) : (
                [...row.tier_entries]
                  .sort((a, b) => (a.game?.title || "").localeCompare(b.game?.title || ""))
                  .map((entry) => {
                  const img = fileUrl(entry.game.cover_image);
                  return (
                    <a class="tier-thumb" href={`/games/${entry.game.slug}/index.html`} title={entry.game.title}>
                      {img ? (
                        <img src={img} alt={entry.game.title} loading="lazy" />
                      ) : (
                        <span style="display:flex;align-items:center;justify-content:center;height:100%;color:#aaa;font-size:12px;">
                          No image
                        </span>
                      )}
                    </a>
                  );
                })
              )}
            </div>
          </div>
        ))}
      </section>
    </main>
</BaseLayout>
