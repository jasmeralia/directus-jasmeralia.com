---
import type { APIContext } from "astro";
import Nav from "../../components/Nav.astro";
import { getPublishedTierListBySlug, listPublishedTierListSlugs, fileUrl } from "../../lib/directus";
import "../../styles/tierlist.css";

// Static generation: /tiers/<slug> for each published tier list
export async function getStaticPaths() {
  const slugs = await listPublishedTierListSlugs();
  return slugs.map((slug) => ({ params: { slug } }));
}

const { slug } = Astro.params;
if (!slug) throw new Error("Missing slug param");

const tierList = await getPublishedTierListBySlug(slug);
if (!tierList) return Astro.redirect("/404");
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{tierList.title}</title>
    <meta name="description" content={tierList.description ?? tierList.title} />
      <link rel="icon" href="/favicon.ico" sizes="any" />
  </head>
  <body style="background:#000010;margin:0;">
    <Nav />
    <main class="tier-page">
      <h1 class="tier-title">{tierList.title}</h1>
      {tierList.description && <p class="tier-desc">{tierList.description}</p>}

      <section class="tier-board" aria-label="Tier list">
        {tierList.tier_rows.map((row) => (
          <div class="tier-row">
            <div class="tier-label" style={`background:${row.color};`}>
              {row.label}
            </div>

            <div class="tier-cells">
              {row.tier_entries.length === 0 ? (
                <div class="tier-empty">No entries</div>
              ) : (
                row.tier_entries.map((entry) => {
                  const img = fileUrl(entry.game.cover_image);
                  return (
                    <a class="tier-thumb" href={`/games/${entry.game.slug}/index.html`} title={entry.game.title}>
                      {img ? (
                        <img src={img} alt={entry.game.title} loading="lazy" />
                      ) : (
                        <span style="display:flex;align-items:center;justify-content:center;height:100%;color:#aaa;font-size:12px;">
                          No image
                        </span>
                      )}
                    </a>
                  );
                })
              )}
            </div>
          </div>
        ))}
      </section>
    </main>
  </body>
</html>
