---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { directusFetchItems } from "../../lib/directus";

const tiers = await directusFetchItems("tier_lists", {
  fields: [
    "id",
    "title",
    "slug",
    "description",
    "updated_at",
    "tier_rows.id",
    "tier_rows.tier_entries.id",
  ],
  filter: { status: { _eq: "published" } },
  sort: ["-updated_at", "title"],
  limit: 500,
});
const countTierEntries = (tier) => {
  const rows = tier?.tier_rows ?? [];
  return rows.reduce((sum, row) => sum + ((row?.tier_entries ?? []).length), 0);
};
---

<BaseLayout title="Tier Lists">
  <div slot="head">
    <style>
      main{padding:24px;}
      .list{max-width:980px;margin:0 auto;}
      .item{border:1px solid #222;border-radius:10px;padding:16px;margin:12px 0;background:#111;}
      .desc{opacity:.85;margin-top:.4rem;}
      .item a{color:#9aa6ff;}
      .item a:visited{color:#9aa6ff;}
    </style>
  </div>
  <main>
      <div class="list">
        <h1>Tier Lists</h1>
        {tiers.length === 0 ? (
          <p>No tier lists yet.</p>
        ) : (
          tiers.map((t) => (
            <div class="item">
              <a href={`/tiers/${t.slug}/index.html`}>{t.title}</a>
              <span style="opacity:.7;"> ({countTierEntries(t)})</span>
              {t.updated_at ? (
                <div class="desc">Updated: {new Date(t.updated_at).toLocaleDateString()}</div>
              ) : null}
              {t.description ? <div class="desc">{t.description}</div> : null}
            </div>
          ))
        )}
      </div>
  </main>
</BaseLayout>
