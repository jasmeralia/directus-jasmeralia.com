---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { directusFetchItems, fileUrl } from "../../lib/directus";

export async function getStaticPaths() {
  const games = await directusFetchItems("games", {
    fields: ["id", "release_year"],
    limit: 1000,
  });

  const years = new Set();
  for (const game of games) {
    const raw = game.release_year;
    const rawString = raw === null || raw === undefined ? "" : String(raw).trim();
    if (!rawString) {
      continue;
    }
    const year = Number(rawString);
    if (Number.isFinite(year)) {
      years.add(year);
    }
  }

  const paths = Array.from(years)
    .sort((a, b) => a - b)
    .map((year) => ({ params: { slug: String(year) } }));

  paths.push({ params: { slug: "unknown" } });
  return paths;
}

const { slug } = Astro.params;
let title = "Unknown";
let games = [];

if (slug === "unknown") {
  const allGames = await directusFetchItems("games", {
    fields: ["id", "title", "slug", "cover_image.id", "cover_image.filename_disk", "release_year"],
    sort: ["title"],
    limit: 1000,
  });
  games = allGames.filter((game) => {
    const raw = game.release_year;
    const rawString = raw === null || raw === undefined ? "" : String(raw).trim();
    return !rawString;
  });
} else {
  const year = Number(slug);
  if (!Number.isFinite(year)) {
    throw new Error(`Invalid release year slug: ${slug}`);
  }
  title = String(year);
  games = await directusFetchItems("games", {
    fields: ["id", "title", "slug", "cover_image.id", "cover_image.filename_disk", "release_year"],
    filter: { release_year: { _eq: year } },
    sort: ["title"],
    limit: 1000,
  });
}

const gameIds = games.map((game) => game.id).filter((id) => typeof id === "number");
const reviewedGameIds = new Set();
if (gameIds.length) {
  const reviews = await directusFetchItems("reviews", {
    fields: ["game.id"],
    filter: { status: { _eq: "published" }, game: { _in: gameIds } },
    limit: 500,
  });
  for (const review of reviews ?? []) {
    const id = review?.game?.id;
    if (typeof id === "number") reviewedGameIds.add(id);
  }
}
---

<BaseLayout title={`Release Years | ${title}`}>
  <div slot="head">
    <style>
      main{padding:2rem;max-width:1100px;margin:0 auto;}
      .panel{background:#111;border:1px solid #222;border-radius:12px;padding:16px;}
      .panel a{color:#9aa6ff;}
      .panel a:visited{color:#9aa6ff;}
      .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;}
      .card{border:1px solid #2b2b2b;border-radius:12px;overflow:hidden;background:#111;}
      .card.reviewed{border-color:#d3a43b;box-shadow:0 0 0 1px rgba(211,164,59,.25);}
      .card a{color:inherit;text-decoration:none;display:block;}
      .thumb{aspect-ratio:2/3;background:#000;display:flex;align-items:center;justify-content:center;}
      .thumb img{width:100%;height:100%;object-fit:contain;display:block;}
      .meta{padding:.75rem 1rem;}
      .title{font-weight:700;}
    </style>
  </div>
  <main>
    <h1>{title}</h1>
    <div class="panel">
      {games.length === 0 ? (
        <p>No games found for this release year.</p>
      ) : (
        <div class="grid">
          {games.map((g) => {
            const img = g.cover_image ? fileUrl(g.cover_image as any) : null;
            const reviewed = reviewedGameIds.has(g.id);
            return (
              <div class={`card${reviewed ? " reviewed" : ""}`}>
                <a href={`/games/${g.slug}/index.html`}>
                  <div class="thumb">
                    {img ? <img src={img} alt={g.title} loading="lazy" /> : <span>No cover</span>}
                  </div>
                  <div class="meta">
                    <div class="title">{g.title}</div>
                  </div>
                </a>
              </div>
            );
          })}
        </div>
      )}
    </div>
  </main>
</BaseLayout>
