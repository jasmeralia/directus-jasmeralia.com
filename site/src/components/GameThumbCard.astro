---
import { fileUrl } from "../lib/directus";

const { game, reviewed = false, sTier = false } = Astro.props;
const labelize = (value) =>
  value ? value.replace(/_/g, " ").replace(/\b\w/g, (c) => c.toUpperCase()) : "";
const completed = game?.player_status === "completed";
const didNotFinish = game?.player_status === "did_not_finish";
const inProgress = game?.player_status === "in_progress";
const statusColor = completed
  ? "#c0c0c0"
  : didNotFinish
    ? "#d14b4b"
    : inProgress
      ? "#70b7ff"
      : null;
const statusOuterGlow = completed
  ? "rgba(192,192,192,.25)"
  : didNotFinish
    ? "rgba(209,75,75,.25)"
    : inProgress
      ? "rgba(112,183,255,.3)"
      : null;
const borderColor = reviewed ? "#d3a43b" : (statusColor ?? "#2b2b2b");
const shadowParts = [];
if (sTier) {
  shadowParts.push(
    "0 0 0 1px rgba(255,255,255,.06)",
    "0 0 14px rgba(255,180,80,.22)",
  );
} else if (reviewed) {
  shadowParts.push("0 0 0 1px rgba(211,164,59,.25)");
} else if (statusOuterGlow) {
  shadowParts.push(`0 0 0 1px ${statusOuterGlow}`);
}
if (reviewed && statusColor) {
  shadowParts.push("inset 0 0 0 2px #d3a43b", `inset 0 0 0 4px ${statusColor}`);
} else if (reviewed) {
  shadowParts.push("inset 0 0 0 2px #d3a43b");
} else if (statusColor) {
  shadowParts.push(`inset 0 0 0 2px ${statusColor}`);
}
const cardStyle = `--card-border:${borderColor};--card-shadow:${shadowParts.length ? shadowParts.join(",") : "none"};`;

const img = game?.cover_image ? fileUrl(game.cover_image) : null;
const genres = (game?.genres ?? []).map((genre) => genre?.genres_id?.name).filter(Boolean);
const engines = (game?.engines ?? []).map((engine) => engine?.engines_id?.title).filter(Boolean);
---

<div class={`card${reviewed ? " reviewed" : ""}${completed ? " completed" : ""}${didNotFinish ? " did-not-finish" : ""}${inProgress ? " in-progress" : ""}${sTier ? " s-tier" : ""}`} style={cardStyle}>
  <a href={`/games/${game.slug}/index.html`}>
    <div class="thumb">
      {img ? <img src={img} alt={game.title} loading="lazy" /> : <span>No cover</span>}
    </div>
    <div class="meta">
      <div class="title">{game.title}</div>
      {game.release_year ? <div class="year">{game.release_year}</div> : null}
      <div class="tags">
        {game.player_status ? <span class="tag">{labelize(game.player_status)}</span> : null}
        {game.game_status ? <span class="tag">{labelize(game.game_status)}</span> : null}
        {genres.map((name) => <span class="tag">{name}</span>)}
        {engines.map((name) => <span class="tag">{name}</span>)}
      </div>
    </div>
  </a>
</div>

<style>
  .card{border:2px solid var(--card-border,#2b2b2b);border-radius:12px;overflow:hidden;background:#111;box-shadow:var(--card-shadow,none);}
  .card.s-tier{
    border:2px solid transparent;
    background:
      linear-gradient(#111, #111) padding-box,
      linear-gradient(135deg,#ff5f6d,#ffc371,#fff45f,#6dff9a,#5fe2ff,#8c7bff,#ff6ddf) border-box;
  }
  .card a{color:inherit;text-decoration:none;display:block;}
  .thumb{aspect-ratio:2/3;background:#000;display:flex;align-items:center;justify-content:center;}
  .thumb img{width:100%;height:100%;object-fit:contain;display:block;}
  .meta{padding:.75rem 1rem;}
  .title{font-weight:700;}
  .year{opacity:.75;font-size:.9rem;}
  .tags{display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.5rem;}
  .tag{font-size:.75rem;padding:.2rem .5rem;border-radius:999px;background:#1a1a1a;border:1px solid #2b2b2b;opacity:.9;}
</style>
