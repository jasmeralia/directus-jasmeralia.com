---
import { fileUrl } from "../lib/directus";
import { getDownloadLinkMeta } from "../lib/download-link";

const { game, reviewed = false, sTier = false } = Astro.props;
const labelize = (value) =>
  value ? value.replace(/_/g, " ").replace(/\b\w/g, (c) => c.toUpperCase()) : "";
const completed = game?.player_status === "completed";
const didNotFinish = game?.player_status === "did_not_finish";
const inProgress = game?.player_status === "in_progress";
const waitingForUpdate = game?.player_status === "waiting_for_update";
const hasWalkthrough = typeof game?.walkthrough_url === "string" && game.walkthrough_url.trim().length > 0;
const statusColor = completed
  ? "#c0c0c0"
  : didNotFinish
    ? "#d14b4b"
    : inProgress
      ? "#70b7ff"
      : waitingForUpdate
        ? "#1f6b2b"
        : null;
const hasStatus = Boolean(statusColor);
const innerBorderColor = hasWalkthrough
  ? "#8c58ff"
  : statusColor ?? (!reviewed && !sTier ? "#2b2b2b" : "transparent");
const statusRingColor = hasWalkthrough ? statusColor : null;
const stackStyle = [
  `--ring-rainbow-pad:${sTier ? 2 : 0}px`,
  `--ring-gold-pad:${reviewed ? 2 : 0}px`,
  `--ring-status-pad:${statusRingColor ? 2 : 0}px`,
  `--ring-status-color:${statusRingColor ?? "transparent"}`,
  `--gap-rainbow-pad:${sTier && (reviewed || hasStatus || hasWalkthrough) ? 1 : 0}px`,
  `--gap-gold-pad:${reviewed && (hasStatus || hasWalkthrough) ? 1 : 0}px`,
  `--gap-status-pad:${statusRingColor ? 1 : 0}px`,
  `--inner-border:${innerBorderColor}`,
].join(";");

const img = game?.cover_image ? fileUrl(game.cover_image) : null;
const downloadMeta = getDownloadLinkMeta(game?.download_url);
const showDownloadPlatform = downloadMeta.label !== "Download";
const hasDownloadUrl = typeof game?.download_url === "string" && /^https?:\/\//i.test(game.download_url.trim());
const genres = (game?.genres ?? [])
  .map((genre) => genre?.genres_id)
  .filter((genre) => genre?.name && genre?.slug);
const engines = (game?.engines ?? [])
  .map((engine) => engine?.engines_id)
  .filter((engine) => engine?.title && engine?.slug);
---

<div class="stack" style={stackStyle}>
  <div class="ring-rainbow">
    <div class="gap-rainbow">
      <div class="ring-gold">
        <div class="gap-gold">
          <div class="ring-status">
            <div class="gap-status">
              <div class="card">
                <a class="game-link" href={`/games/${game.slug}/index.html`}>
                  <div class="thumb">
                    {img ? <img src={img} alt={game.title} loading="lazy" /> : <span>No cover</span>}
                  </div>
                </a>
                <div class="meta">
                  <div class="title">
                    <a class="game-link" href={`/games/${game.slug}/index.html`}>{game.title}</a>
                  </div>
                  {game.release_year ? <div class="year">{game.release_year}</div> : null}
                  {showDownloadPlatform ? (
                    <div class="platform">
                      {hasDownloadUrl ? (
                        <a class="platform-link" href={game.download_url} target="_blank" rel="noopener noreferrer">
                          {downloadMeta.icon ? <img src={downloadMeta.icon} alt="" aria-hidden="true" loading="lazy" /> : null}
                          <span>{downloadMeta.label}</span>
                        </a>
                      ) : (
                        <>
                          {downloadMeta.icon ? <img src={downloadMeta.icon} alt="" aria-hidden="true" loading="lazy" /> : null}
                          <span>{downloadMeta.label}</span>
                        </>
                      )}
                    </div>
                  ) : null}
                  <div class="tags">
                    {game.player_status ? (
                      <a class="tag" href={`/played_statuses/${game.player_status}/index.html`}>{labelize(game.player_status)}</a>
                    ) : null}
                    {game.game_status ? (
                      <a class="tag" href={`/game_statuses/${game.game_status}/index.html`}>{labelize(game.game_status)}</a>
                    ) : null}
                    {genres.map((genre) => (
                      <a class="tag" href={`/genres/${genre.slug}/index.html`}>{genre.name}</a>
                    ))}
                    {engines.map((engine) => (
                      <a class="tag" href={`/engines/${engine.slug}/index.html`}>{engine.title}</a>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .stack,.ring-rainbow,.gap-rainbow,.ring-gold,.gap-gold,.ring-status,.gap-status,.card{border-radius:12px;}
  .ring-rainbow,.gap-rainbow,.ring-gold,.gap-gold,.ring-status,.gap-status{padding:0;background:transparent;}
  .ring-rainbow{
    padding:var(--ring-rainbow-pad,0);
    background:linear-gradient(135deg,#ff5f6d,#ffc371,#fff45f,#6dff9a,#5fe2ff,#8c7bff,#ff6ddf);
    box-shadow:0 0 0 1px rgba(255,255,255,.06), 0 0 14px rgba(255,180,80,.22);
  }
  .gap-rainbow{padding:var(--gap-rainbow-pad,0);background:#000;}
  .ring-gold{padding:var(--ring-gold-pad,0);background:#d3a43b;}
  .gap-gold{padding:var(--gap-gold-pad,0);background:#000;}
  .ring-status{padding:var(--ring-status-pad,0);background:var(--ring-status-color,transparent);}
  .gap-status{padding:var(--gap-status-pad,0);background:#000;}
  .card{border:2px solid var(--inner-border,#2b2b2b);overflow:hidden;background:#111;}
  .card a{color:inherit;text-decoration:none;}
  .game-link{display:block;}
  .thumb{aspect-ratio:2/3;background:#000;display:flex;align-items:center;justify-content:center;}
  .thumb img{width:100%;height:100%;object-fit:contain;display:block;}
  .meta{padding:.75rem 1rem;}
  .title{font-weight:700;}
  .year{opacity:.75;font-size:.9rem;}
  .platform{display:flex;align-items:center;gap:.35rem;opacity:.85;font-size:.85rem;margin-top:.3rem;}
  .platform-link{display:flex;align-items:center;gap:.35rem;}
  .platform img{width:.9rem;height:.9rem;display:block;filter:brightness(0) saturate(100%) invert(67%) sepia(11%) saturate(1832%) hue-rotate(194deg) brightness(97%) contrast(96%);}
  .tags{display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.5rem;}
  .tag{font-size:.75rem;padding:.2rem .5rem;border-radius:999px;background:#1a1a1a;border:1px solid #2b2b2b;opacity:.9;}
</style>
