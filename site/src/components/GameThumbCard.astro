---
import { fileUrl } from "../lib/directus";
import { getDownloadLinkMeta } from "../lib/download-link";

const { game, reviewed = false, sTier = false } = Astro.props;
const labelize = (value) =>
  value ? value.replace(/_/g, " ").replace(/\b\w/g, (c) => c.toUpperCase()) : "";
const completed = game?.player_status === "completed";
const didNotFinish = game?.player_status === "did_not_finish";
const inProgress = game?.player_status === "in_progress";
const waitingForUpdate = game?.player_status === "waiting_for_update";
const statusColor = completed
  ? "#c0c0c0"
  : didNotFinish
    ? "#d14b4b"
    : inProgress
      ? "#70b7ff"
      : waitingForUpdate
        ? "#1f6b2b"
        : null;
const hasStatus = Boolean(statusColor);
const layerCount = (sTier ? 1 : 0) + (reviewed ? 1 : 0) + (hasStatus ? 1 : 0);
const hasTwoLayers = layerCount === 2;
const hasThreeLayers = Boolean(sTier && reviewed && hasStatus);
const innerBorderColor = statusColor ?? (!reviewed && !sTier ? "#2b2b2b" : "transparent");

const img = game?.cover_image ? fileUrl(game.cover_image) : null;
const downloadMeta = getDownloadLinkMeta(game?.download_url);
const showDownloadPlatform = downloadMeta.label !== "Download";
const genres = (game?.genres ?? []).map((genre) => genre?.genres_id?.name).filter(Boolean);
const engines = (game?.engines ?? []).map((engine) => engine?.engines_id?.title).filter(Boolean);
---

<div class={`stack${reviewed ? " reviewed" : ""}${sTier ? " s-tier" : ""}${hasStatus ? " has-status" : ""}${hasTwoLayers ? " two-layers" : ""}${hasThreeLayers ? " three-layers" : ""}`}>
  <div class="ring-rainbow">
    <div class="gap-rainbow">
      <div class="ring-gold">
        <div class="gap-gold">
          <div class="card" style={`--inner-border:${innerBorderColor};`}>
            <a href={`/games/${game.slug}/index.html`}>
              <div class="thumb">
                {img ? <img src={img} alt={game.title} loading="lazy" /> : <span>No cover</span>}
              </div>
              <div class="meta">
                <div class="title">{game.title}</div>
                {game.release_year ? <div class="year">{game.release_year}</div> : null}
                {showDownloadPlatform ? (
                  <div class="platform">
                    {downloadMeta.icon ? <img src={downloadMeta.icon} alt="" aria-hidden="true" loading="lazy" /> : null}
                    <span>{downloadMeta.label}</span>
                  </div>
                ) : null}
                <div class="tags">
                  {game.player_status ? <span class="tag">{labelize(game.player_status)}</span> : null}
                  {game.game_status ? <span class="tag">{labelize(game.game_status)}</span> : null}
                  {genres.map((name) => <span class="tag">{name}</span>)}
                  {engines.map((name) => <span class="tag">{name}</span>)}
                </div>
              </div>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .stack,.ring-rainbow,.gap-rainbow,.ring-gold,.gap-gold,.card{border-radius:12px;}
  .ring-rainbow,.gap-rainbow,.ring-gold,.gap-gold{padding:0;background:transparent;}
  .stack.s-tier .ring-rainbow{
    padding:2px;
    background:linear-gradient(135deg,#ff5f6d,#ffc371,#fff45f,#6dff9a,#5fe2ff,#8c7bff,#ff6ddf);
    box-shadow:0 0 0 1px rgba(255,255,255,.06), 0 0 14px rgba(255,180,80,.22);
  }
  .stack.reviewed .ring-gold{padding:2px;background:#d3a43b;}
  .stack.two-layers.s-tier.reviewed .gap-rainbow{padding:1px;background:#000;}
  .stack.two-layers.s-tier.has-status:not(.reviewed) .gap-rainbow{padding:1px;background:#000;}
  .stack.two-layers.reviewed.has-status:not(.s-tier) .gap-gold{padding:1px;background:#000;}
  .stack.three-layers .gap-rainbow{padding:1px;background:#000;}
  .stack.three-layers .gap-gold{padding:1px;background:#000;}
  .card{border:2px solid var(--inner-border,#2b2b2b);overflow:hidden;background:#111;}
  .card a{color:inherit;text-decoration:none;display:block;}
  .thumb{aspect-ratio:2/3;background:#000;display:flex;align-items:center;justify-content:center;}
  .thumb img{width:100%;height:100%;object-fit:contain;display:block;}
  .meta{padding:.75rem 1rem;}
  .title{font-weight:700;}
  .year{opacity:.75;font-size:.9rem;}
  .platform{display:flex;align-items:center;gap:.35rem;opacity:.85;font-size:.85rem;margin-top:.3rem;}
  .platform img{width:.9rem;height:.9rem;display:block;filter:brightness(0) saturate(100%) invert(67%) sepia(11%) saturate(1832%) hue-rotate(194deg) brightness(97%) contrast(96%);}
  .tags{display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.5rem;}
  .tag{font-size:.75rem;padding:.2rem .5rem;border-radius:999px;background:#1a1a1a;border:1px solid #2b2b2b;opacity:.9;}
</style>
